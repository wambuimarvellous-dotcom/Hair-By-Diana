<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hair, Lashes & Nails by Diana Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .calendar-day-cell.disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .calendar-day-cell.booked-day {
            background-color: #fecaca;
        }
        .timeslot-btn.booked {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            border-style: dashed;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
        <header class="text-center border-b pb-4 mb-4">
            <h1 class="text-4xl font-bold text-gray-800 tracking-wide">Hair, Lashes & Nails by Diana</h1>
            <p class="text-lg text-gray-600">Online Booking</p>
        </header>

        <div id="loading-message" class="text-center text-gray-500 my-4">Connecting to database...</div>

        <div id="main-content" class="flex flex-col lg:flex-row gap-8 hidden">
            <div class="w-full lg:w-1/2">
                <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="current-month" class="text-xl font-semibold text-gray-700"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center font-medium text-sm text-gray-500 mb-2">
                        <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>

            <div class="w-full lg:w-1/2">
                <div id="timeslots-container" class="bg-gray-50 p-4 rounded-xl shadow-inner mb-6 hidden">
                    <h3 id="selected-date-title" class="text-lg font-semibold text-gray-700 mb-3">Available Time Ranges</h3>
                    
                    <form id="time-range-form" class="space-y-4">
                        <div>
                            <label for="client-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                            <input type="text" id="client-name" required placeholder="e.g. Jane Doe" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                        </div>
                        <div>
                            <label for="start-time" class="block text-sm font-medium text-gray-700">Start Time</label>
                            <select id="start-time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                                <option value="">Select a start time</option>
                            </select>
                        </div>
                        <div>
                            <label for="end-time" class="block text-sm font-medium text-gray-700">End Time</label>
                            <select id="end-time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                                <option value="">Select an end time</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-xl font-semibold hover:bg-purple-700 transition duration-300 shadow-md">
                            Continue to Payment
                        </button>
                    </form>
                    <p id="no-timeslots" class="text-gray-400 text-center mt-4 hidden">No available timeslots for this day.</p>
                </div>
                
                <div id="confirmation-container" class="bg-yellow-50 p-6 rounded-xl shadow-inner hidden">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-3 text-center">Final Step: Secure Your Slot</h3>
                    
                    <div class="bg-white p-4 rounded-lg border border-yellow-200 mb-6">
                        <p class="text-sm font-bold text-gray-700 mb-2">To secure your booking, please pay a commitment fee of <span class="text-purple-700">Ksh 300</span>:</p>
                        <div class="text-sm text-gray-600 space-y-1 mb-4 bg-gray-50 p-3 rounded">
                            <p>1. Go to M-PESA</p>
                            <p>2. Select <b>Send Money</b></p>
                            <p>3. Phone: <b>0743407631</b> (Diana)</p>
                            <p>4. Amount: <b>300</b></p>
                        </div>
                        
                        <label for="mpesa-code" class="block text-sm font-medium text-gray-700">M-Pesa Transaction Code</label>
                        <input type="text" id="mpesa-code" required placeholder="e.g. SAK27..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2 uppercase">
                        <p class="text-xs text-gray-500 mt-1 italic">*Required to verify your booking.</p>
                    </div>

                    <button id="whatsapp-confirm-btn" class="w-full inline-flex items-center justify-center bg-green-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-600 transition duration-300 shadow-lg disabled:opacity-50" disabled>
                        <span id="whatsapp-loader" class="hidden loader"></span>
                        <svg id="whatsapp-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.04 2.22c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.5 3.42 1.46 4.86l-1.5 5.48 5.6-1.47c1.4.78 2.94 1.2 4.5 1.2 5.46 0 9.91-4.45 9.91-9.91s-4.45-9.91-9.91-9.91zm0 18.04c-1.5 0-2.93-.41-4.17-1.16l-.29-.17-3.05.8-1.57-2.61.2-.26c-1.01-1.42-1.59-3.08-1.59-4.87 0-4.5 3.65-8.16 8.16-8.16s8.16 3.65 8.16 8.16c0 4.5-3.65 8.16-8.16 8.16zm5.12-6.5c-.28-.14-.58-.2-.89-.24-.31-.04-.63-.07-.94-.07-.94 0-1.87.27-2.6.84-.73.57-1.19 1.4-1.19 2.37v.06c0 .28-.2.58-.5.58-.1 0-.25-.04-.37-.09-.13-.05-.28-.12-.4-.19-.12-.07-.25-.16-.36-.26-.1-.1-.2-.22-.3-.35-.1-.13-.19-.28-.27-.44-.09-.17-.16-.35-.22-.54-.06-.2-.09-.4-.09-.6.04-.36.19-.69.41-1.01.21-.32.49-.57.81-.8.29-.21.5-.47.66-.78.16-.31.25-.66.25-1.03 0-.46-.14-.88-.41-1.29-.27-.41-.62-.76-1.03-1.07-.42-.31-.88-.55-1.37-.73-.49-.18-1.01-.27-1.53-.27-.51 0-.97.12-1.36.35-.39.23-.71.53-.96.9-.25.37-.41.8-.49 1.29-.08.49-.06 1.01.06 1.53.12.52.32.99.6 1.41.28.42.64.79 1.05 1.13.4.34.86.64 1.35.88.49.24 1.02.43 1.57.56.55.13 1.12.19 1.7.19 1.54 0 3.02-.68 4.09-1.92.22-.26.33-.55.33-.86 0-.27-.1-.53-.29-.76z"></path>
                        </svg>
                        <span id="whatsapp-text">Send Confirmation Message</span>
                    </button>
                    <p id="booking-error" class="mt-4 text-red-600 hidden">Booking failed. Please try again.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdOltW9_5YxAI4JObxHYVvkH8Ubh9tXnM",
            authDomain: "hair-by-diana.firebaseapp.com",
            projectId: "hair-by-diana",
            storageBucket: "hair-by-diana.firebasestorage.app",
            messagingSenderId: "254702590742",
            appId: "1:254702590742:web:8b1007b3792bbb4d908e37",
            measurementId: "G-3643RVMJK1"
        };
        
        const DIANA_WHATSAPP_NUMBER = '254743407631'; 
        
        let db, auth, appointmentsCol, userId;
        let currentMonth = new Date();
        let selectedDate = null;
        let bookedSlots = [];
        let currentBookingData = null;

        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthDisplay = document.getElementById('current-month');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const timeslotsContainer = document.getElementById('timeslots-container');
        const timeRangeForm = document.getElementById('time-range-form');
        const startTimeSelect = document.getElementById('start-time');
        const endTimeSelect = document.getElementById('end-time');
        const selectedDateTitle = document.getElementById('selected-date-title');
        const noTimeslotsMsg = document.getElementById('no-timeslots');
        const confirmationContainer = document.getElementById('confirmation-container');
        const whatsappConfirmBtn = document.getElementById('whatsapp-confirm-btn');
        const mpesaCodeInput = document.getElementById('mpesa-code');
        const whatsappLoader = document.getElementById('whatsapp-loader');
        const whatsappText = document.getElementById('whatsapp-text');
        const loadingMessage = document.getElementById('loading-message');
        const mainContent = document.getElementById('main-content');
        const clientNameInput = document.getElementById('client-name');
        const bookingErrorMsg = document.getElementById('booking-error');

        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        appointmentsCol = collection(db, `/artifacts/hair-by-diana/public/data/appointments`); 
                        
                        renderCalendar();
                        loadBookedSlots();
                        loadingMessage.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        
                        whatsappConfirmBtn.addEventListener('click', handleWhatsAppConfirmation);
                        
                        // Enable/Disable WhatsApp button based on M-Pesa code input
                        mpesaCodeInput.addEventListener('input', () => {
                            whatsappConfirmBtn.disabled = mpesaCodeInput.value.trim().length < 5;
                        });
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };

        const renderCalendar = () => {
            const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const startDay = firstDayOfMonth.getDay();
            
            currentMonthDisplay.textContent = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';
            
            for (let i = 0; i < startDay; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('p-2', 'rounded-md', 'text-center', 'cursor-pointer', 'transition', 'hover:bg-purple-200', 'calendar-day-cell');
                const fullDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                dayElement.textContent = day;
                dayElement.dataset.date = fullDate.toISOString(); 

                if (fullDate.getDay() === 0 || fullDate < new Date().setHours(0,0,0,0)) {
                    dayElement.classList.add('disabled');
                } else {
                    dayElement.addEventListener('click', () => {
                        selectedDate = fullDate;
                        document.querySelectorAll('.calendar-day-cell').forEach(el => el.classList.remove('ring-2', 'ring-purple-500', 'ring-offset-2'));
                        dayElement.classList.add('ring-2', 'ring-purple-500', 'ring-offset-2');
                        resetView(false);
                        renderTimeSelects();
                    });
                }
                calendarGrid.appendChild(dayElement);
            }
        };

        const loadBookedSlots = () => {
            if (!appointmentsCol) return;
            const startOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const endOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0, 23, 59, 59);

            const q = query(appointmentsCol, where('startDateTime', '>=', startOfMonth.toISOString()), where('startDateTime', '<=', endOfMonth.toISOString()));

            onSnapshot(q, (snapshot) => {
                bookedSlots = snapshot.docs.map(doc => ({
                    start: new Date(doc.data().startDateTime),
                    end: new Date(doc.data().endDateTime)
                }));
                
                document.querySelectorAll('.calendar-day-cell').forEach(cell => {
                    cell.classList.remove('booked-day');
                    const cellDate = new Date(cell.dataset.date).toDateString();
                    if (bookedSlots.some(slot => slot.start.toDateString() === cellDate)) {
                        cell.classList.add('booked-day');
                    }
                });
                renderTimeSelects();
            });
        };

        const renderTimeSelects = () => {
            if (!selectedDate || selectedDate.getDay() === 0) {
                timeslotsContainer.classList.add('hidden');
                return;
            }
            timeslotsContainer.classList.remove('hidden');
            selectedDateTitle.textContent = `Available Time Ranges for ${selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`;
            startTimeSelect.innerHTML = '<option value="">Select a start time</option>';
            const slots = generateTimeSlots('09:00', '17:00', 30);
            let hasAvailableSlots = false;

            slots.forEach(time => {
                const [h, m] = time.split(':');
                const slotDT = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), h, m);
                const isBooked = bookedSlots.some(range => slotDT >= range.start && slotDT < range.end);
                const opt = document.createElement('option');
                opt.value = time; opt.textContent = time + (isBooked ? ' (Fully Booked)' : '');
                if (isBooked) opt.disabled = true; else hasAvailableSlots = true;
                startTimeSelect.appendChild(opt);
            });

            if (!hasAvailableSlots) {
                noTimeslotsMsg.classList.remove('hidden');
                timeRangeForm.classList.add('hidden');
            } else {
                noTimeslotsMsg.classList.add('hidden');
                timeRangeForm.classList.remove('hidden');
            }
        };

        startTimeSelect.addEventListener('change', () => {
            endTimeSelect.innerHTML = '<option value="">Select an end time</option>';
            if (!startTimeSelect.value) return;
            const slots = generateTimeSlots('09:00', '17:00', 30);
            const startIndex = slots.indexOf(startTimeSelect.value);
            for (let i = startIndex + 1; i < slots.length; i++) {
                const [eh, em] = slots[i].split(':');
                const checkDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), eh, em);
                const [sh, sm] = startTimeSelect.value.split(':').map(Number);
                let cur = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), sh, sm);
                let overlap = false;
                while (cur < checkDate) {
                    if (bookedSlots.some(r => cur >= r.start && cur < r.end)) { overlap = true; break; }
                    cur.setMinutes(cur.getMinutes() + 30);
                }
                if (overlap) break;
                const opt = document.createElement('option');
                opt.value = slots[i]; opt.textContent = slots[i];
                endTimeSelect.appendChild(opt);
            }
        });

        const generateTimeSlots = (start, end, interval) => {
            const res = [];
            let cur = new Date(); cur.setHours(...start.split(':'), 0, 0);
            let stop = new Date(); stop.setHours(...end.split(':'), 0, 0);
            while (cur < stop) {
                res.push(cur.getHours().toString().padStart(2, '0') + ':' + cur.getMinutes().toString().padStart(2, '0'));
                cur.setMinutes(cur.getMinutes() + interval);
            }
            return res;
        };

        timeRangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const [sh, sm] = startTimeSelect.value.split(':').map(Number);
            const [eh, em] = endTimeSelect.value.split(':').map(Number);
            currentBookingData = {
                name: clientNameInput.value.trim(),
                startDateTime: new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), sh, sm).toISOString(),
                endDateTime: new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), eh, em).toISOString(),
                createdAt: new Date().toISOString()
            };
            timeslotsContainer.classList.add('hidden');
            confirmationContainer.classList.remove('hidden');
        });

        const handleWhatsAppConfirmation = async (e) => {
            e.preventDefault();
            const mpesaCode = mpesaCodeInput.value.trim().toUpperCase();
            if (!mpesaCode) return;

            whatsappConfirmBtn.disabled = true;
            whatsappText.textContent = 'Securing Slot...';
            whatsappLoader.classList.remove('hidden');

            try {
                // Add MPESA code to data
                const finalBooking = { ...currentBookingData, mpesaCode: mpesaCode, deposit: 300 };
                await addDoc(appointmentsCol, finalBooking);
                
                const dateStr = new Date(finalBooking.startDateTime).toLocaleDateString();
                const timeStr = new Date(finalBooking.startDateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const msg = `Hello Diana, I've booked an appointment for ${dateStr} at ${timeStr}. Name: ${finalBooking.name}. M-Pesa Code: ${mpesaCode}`;
                
                window.location.href = `https://wa.me/${DIANA_WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
            } catch (error) {
                console.error(error);
                whatsappConfirmBtn.disabled = false;
                whatsappText.textContent = 'Try Again';
                whatsappLoader.classList.add('hidden');
                bookingErrorMsg.classList.remove('hidden');
            }
        };

        const resetView = (resetDate = false) => {
            if (resetDate) selectedDate = null;
            currentBookingData = null;
            mpesaCodeInput.value = '';
            timeRangeForm.reset();
            timeslotsContainer.classList.add('hidden');
            confirmationContainer.classList.add('hidden');
        };

        prevMonthBtn.addEventListener('click', () => { currentMonth.setMonth(currentMonth.getMonth() - 1); renderCalendar(); loadBookedSlots(); resetView(true); });
        nextMonthBtn.addEventListener('click', () => { currentMonth.setMonth(currentMonth.getMonth() + 1); renderCalendar(); loadBookedSlots(); resetView(true); });
        window.onload = initializeFirebase;
    </script>
</body>
</html>
